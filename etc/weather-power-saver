#!/bin/sh
#
# weather-power-saver
#
# This script is executed by power-saver.
# Make sure that the script will "exit 0" on success or any other
# value on error.
#
# In order to enable or disable this script just change the execution
# bits.
#

# Weather Station power saving...
# Set ENABLE to "true" to let the script run at boot time.
ENABLE="true"
NAME=rtcwake
WAKETIME=60
SLEEPTIME=300
DAYTIME=06:30
NIGHTTIME=19:00
NSLEEPTIME=1800
SETTIME="false"
RUN=/usr/sbin/$NAME
RUNOPTS="-m standby -s"

# if not enabled then exit gracefully
[ "$ENABLE" = "true" ] || exit 0

# Exit if the package is not installed
[ -x "$RUN" ] || exit 0

# Load the VERBOSE setting and other rcS variables
. /lib/init/vars.sh

# Define LSB log_* functions.
# Depend on lsb-base (>= 3.2-14) to ensure that this file is present
# and status_of_proc is working.
. /lib/lsb/init-functions

while true; do
    sleep $WAKETIME
    service weewx stop
    yes | /usr/bin/wee_device --clear
    
    DAY=$(date "+%u")
    if [ "$DAY" -eq 7 ] && [ "$SETTIME" = "false" ]
    then
        SETTIME="true"
        /usr/bin/wee_device --set-time
    elif [ "$DAY" -ne 7 ]
    then
        SETTIME="false"
    fi
    
    NOW=$(date "+%s")
    if [ "$NOW" -gt $(date "+%s" -d $DAYTIME) ] && [ "$NOW" -lt $(date "+%s" -d $NIGHTTIME) ]
    then
        $RUN $RUNOPTS $SLEEPTIME
    else
        $RUN $RUNOPTS $NSLEEPTIME
    fi
    
    command-wait-online --timeout 60
    
    # Optional webcam (daytime only)
    if [ "$NOW" -gt $(date "+%s" -d $DAYTIME) ] && [ "$NOW" -lt $(date "+%s" -d $NIGHTTIME) ]
    then
        fswebcam -r 1280x720 -S 100 --timestamp "%H:%M:%S (%Z) %a %d %B %Y" -d /dev/video0 --jpeg 75 --title "NHPC webcam - East Hill" /tmp/image.jpg --exec /etc/upload.sh
    fi
    
    service weewx start
done

exit 0
